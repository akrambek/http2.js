#
# Copyright 2007-2015, Kaazing Corporation. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

property location 'http://localhost:8080/echo'
accept ${location}
accepted
connected

read method "GET"
read version "HTTP/1.1"
read header "Host" "localhost:8080"
read header "Upgrade" /(?i:websocket)/
read header "Connection" /(?i:Upgrade)/
read header "Sec-WebSocket-Key" /(?<key>[a-zA-Z0-9+\/=]{24})/
read header "Sec-WebSocket-Version" "13"

write status "101" "Switching Protocols"
write version "HTTP/1.1"
write header "Upgrade" "websocket"
write header "Connection" "Upgrade"
write header "Sec-WebSocket-Accept" ${ws:handshakeHash(key)}

# HTTP 2 Priority
read [0x82 0x98] ([0..4] :readMask)
read option mask ${readMask}
read "PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n"
read option mask [0x00 0x00 0x00 0x00]

# HTTP 2 Settings
read [0x82 0x89] ([0..4] :readMask)
read option mask ${readMask}
read [0x00 0x00 0x00]
read [0x04]
read [0x00]
read [0x00 0x00 0x00 0x00]
read option mask [0x00 0x00 0x00 0x00]

# Ack Settings
write [0x82 0x09]
write [0x00 0x00 0x00]
write [0x04]
write [0x01]
write [0x00 0x00 0x00 0x00]

# HTTP 2 Headers
read [0x82 0x89] ([0..4] :readMask)
read option mask ${readMask}
read [0x00 0x00 0x0b]                           # length = 11
read [0x01]                                     # type = headers
read [0x04]                                     # flags
read [0x00 0x00 0x00 0x01]                      # stream id = 1
read option mask [0x00 0x00 0x00 0x00]

  # Authority
read [0x82 0x8b] ([0..4] :readMask)
read option mask ${readMask}
read [0x86 0x82 0x41 0x86 0xa0 0xe4 0x1d 0x13 0x9d 0x09 0x84]
read option mask [0x00 0x00 0x00 0x00]

# Content (0 length)
read [0x82 0x89] ([0..4] :readMask)
read option mask ${readMask}
read [0x00 0x00 0x00]                           # length = 0
read [0x00]                                     # type = data
read [0x01]
read [0x00 0x00 0x00 0x01]                      # stream id = 1
read option mask [0x00 0x00 0x00 0x00]


### Response HEADERS

# HEADERS frame <length=69, flags=0x04, stream_id=1>
#          ; END_HEADERS
#          (padlen=0)
#          ; First response header
#          :status: 404
#          server: nghttpd nghttp2/1.19.0
#          date: Wed, 01 Feb 2017 19:12:46 GMT
#          content-type: text/html; charset=UTF-8
#          content-length: 147
write [0x82 0x4E]
write [0x00 0x00 0x45 0x01 0x04 0x00 0x00 0x00 0x01 0x8d 0x76 0x90 0xaa 0x69 0xd2 0x9a]
      [0xe4 0x52 0xa9 0xa7 0x4a 0x6b 0x13 0x01 0x5c 0x2f 0xae 0x0f 0x61 0x96 0xe4 0x59]
      [0x3e 0x94 0x00 0x54 0xc2 0x58 0xd4 0x10 0x02 0xea 0x81 0x7e 0xe0 0x45 0x71 0xa7]
      [0x14 0xc5 0xa3 0x7f 0x5f 0x92 0x49 0x7c 0xa5 0x89 0xd3 0x4d 0x1f 0x6a 0x12 0x71]
      [0xd8 0x82 0xa6 0x0e 0x1b 0xf0 0xac 0xf7 0x0f 0x0d 0x03 0x31 0x34 0x37]

# DATA frame <length=147, flags=0x01, stream_id=1>
#          ; END_STREAM
# <html><head><title>404 Not Found</title></head><body><h1>404 Not Found</h1><hr><address>nghttpd nghttp2/1.19.0 at port 8080</address></body></html>
write [0x82 0x9a]
write [0x93 0x00 0x01 0x00 0x00 0x00 0x01 0x3c 0x68 0x74 0x6d 0x6c 0x3e 0x3c 0x68 0x65]
      [0x61 0x64 0x3e 0x3c 0x74 0x69 0x74 0x6c 0x65 0x3e 0x34 0x30 0x34 0x20 0x4e 0x6f]
      [0x74 0x20 0x46 0x6f 0x75 0x6e 0x64 0x3c 0x2f 0x74 0x69 0x74 0x6c 0x65 0x3e 0x3c]
      [0x2f 0x68 0x65 0x61 0x64 0x3e 0x3c 0x62 0x6f 0x64 0x79 0x3e 0x3c 0x68 0x31 0x3e]
      [0x34 0x30 0x34 0x20 0x4e 0x6f 0x74 0x20 0x46 0x6f 0x75 0x6e 0x64 0x3c 0x2f 0x68]
      [0x31 0x3e 0x3c 0x68 0x72 0x3e 0x3c 0x61 0x64 0x64 0x72 0x65 0x73 0x73 0x3e 0x6e]
      [0x67 0x68 0x74 0x74 0x70 0x64 0x20 0x6e 0x67 0x68 0x74 0x74 0x70 0x32 0x2f 0x31]
      [0x2e 0x31 0x39 0x2e 0x30 0x20 0x61 0x74 0x20 0x70 0x6f 0x72 0x74 0x20 0x38 0x30]
      [0x38 0x30 0x3c 0x2f 0x61 0x64 0x64 0x72 0x65 0x73 0x73 0x3e 0x3c 0x2f 0x62 0x6f]
      [0x64 0x79 0x3e 0x3c 0x2f 0x68 0x74 0x6d 0x6c 0x3e]